name: Deploy Jacommi to EC2

on:
  push:
    branches: [ "main" ]   # main ì— í‘¸ì‹œë  ë•Œë§ˆë‹¤ ìë™ ë°°í¬
  workflow_dispatch:       # í•„ìš”í•˜ë©´ Actions íƒ­ì—ì„œ ìˆ˜ë™ìœ¼ë¡œë„ ì‹¤í–‰ ê°€ëŠ¥

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository (for logging only)
        uses: actions/checkout@v4

      - name: Deploy via SSH to EC2
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          script: |
            set -e

            echo "== 1) í”„ë¡œì íŠ¸ ë””ë ‰í„°ë¦¬ë¡œ ì´ë™ =="
            cd ${{ secrets.EC2_PROJECT_DIR }}

            echo "== 2) ìµœì‹  main ê°€ì ¸ì˜¤ê¸° =="
            git fetch origin main
            git reset --hard origin/main

            echo "== 3) Docker compose ì¬ì‹œì‘ =="
            docker compose down
            docker compose up -d --build

            echo "== 4) ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰ =="
            docker compose exec -T web python manage.py migrate --noinput

            echo "== 5) ì˜¤ëŠ˜ ë¬¸ì¥ ê°•ì œ ìƒì„± (í…ŒìŠ¤íŠ¸/ì´ˆê¸°í™”ìš©) =="
            docker compose exec -T web python manage.py generate_daily_set --force --topic auto

            echo "ë°°í¬ ì™„ë£Œ ğŸ‰"